- name: Install tmux dependencies
  apt: pkg={{ item }} state=present update_cache=yes cache_valid_time=604800
  with_items:
    - libevent-dev
    - libncurses5-dev
  sudo: yes

- name: Get sources for tmux 1.9a
  get_url: url=http://downloads.sourceforge.net/tmux/tmux-1.9a.tar.gz dest=~/compressed/tmux-1.9a.tar.gz timeout=100000 sha256sum=c5e3b22b901cf109b20dab54a4a651f0471abd1f79f6039d79b250d21c2733f5

- name: Extract tmux sources
  unarchive: src=~/compressed/tmux-1.9a.tar.gz dest=~/software/ creates=~/software/tmux-1.9a

- name: Install tmux
  shell: cd ~/software/tmux-1.9a/ && ./configure --prefix={{ ansible_env["HOME"] }}/local_packages/ && make && make install creates={{ ansible_env["HOME"] }}/local_packages/bin/tmux

- name: Install TPM
  git: repo=https://github.com/tmux-plugins/tpm.git depth=1 accept_hostkey=True update=yes dest=~/.tmux/plugins/tpm

- name: Copy custom .tmux.conf
  copy: src=.tmux.conf dest=~/.tmux.conf backup=yes
  
  # If we are already in tmux simply split the window and run the command
  # Supressed changed, since there is no way to detect if the plugins were
  # installed or simply skipped other than checking directory's mod time
  # which feels an overkill
- name: Install tmux plugins (in a tmux session)
  shell: tmux split-window '~/.tmux/plugins/tpm/scripts/install_plugins.sh'
  when: lookup('env', 'TMUX')
  changed_when: False

  # Otherwise we need to start the server, create a session and then run the shell command
- name: Install tmux plugins (outside a tmux session)
  shell: tmux start-server \; new-session -d \; run-shell 'PATH=~/local_packages/bin:$PATH ~/.tmux/plugins/tpm/scripts/install_plugins.sh'
  when: not lookup('env', 'TMUX') 
  changed_when: False
