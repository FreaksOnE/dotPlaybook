- name: Install Git
  block:
    - name: Get sources for Git
      get_url: url=https://mirrors.edge.kernel.org/pub/software/scm/git/git-{{git_version}}.tar.xz dest=~/compressed/git-{{git_version}}.tar.xz timeout=100000 sha256sum={{git_src_sha256sum}}

    - name: Extract Git sources
      unarchive: src=~/compressed/git-{{git_version}}.tar.xz dest=~/software/ creates=~/software/git-{{git_version}}
      register: git_source

    - name: Check if diff-highlight is installed
      stat: path=~/.local/bin/diff-highlight
      register: diff_higlight_installation
      changed_when: no

    - name: Compile and install diff-highlight
      shell: cd ~/software/git-{{git_version}}/contrib/diff-highlight && make && cp diff-highlight ~/.local/bin/diff-highlight
      when: git_source is changed or not diff_higlight_installation.stat.exists

  tags:
    - git
    - provision

- name: Install tig
  block:
    - name: Get sources for Tig
      git: repo=https://github.com/jonas/tig.git accept_hostkey=yes dest=~/software/tig version={{tig_version}}
      register: tig_checkout

    - name: Check if tig is installed
      shell: which tig
      register: tig_installed
      ignore_errors: yes
      failed_when: no
      changed_when: no

    - name: Install Tig
      shell: cd ~/software/tig && make distclean ; autoreconf -i -I tools && ./configure --prefix=$HOME/.local/ && make && make install
      when: tig_checkout is changed or tig_installed.rc == 1

  tags:
    - git
    - tig
    - provision

- name: Symlink Git config file
  install_dot: src=files/gitconfig dest=~/.gitconfig
  tags:
    - git
    - configuration
